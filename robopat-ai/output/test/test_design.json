{
  "requirement": "\n毎朝9時に、SUUMOの管理画面にログインして、\n新着の反響データ（問い合わせ）を取得し、\nExcelファイルに追記保存する。\n\n対象システム: SUUMO 業務支援サイト\nログイン情報: 環境変数から取得\n出力先: C:/RoboPat/反響データ.xlsx\n",
  "basic_design": {
    "project_name": "SUUMO反響データ自動取得",
    "overview": "毎朝9時にSUUMO管理画面から新着反響データを取得し、Excelファイルに追記保存する自動化処理",
    "target_systems": [
      {
        "name": "SUUMO 業務支援サイト",
        "type": "Web",
        "url_or_path": "https://suumo.jp/"
      },
      {
        "name": "反響データExcelファイル",
        "type": "Excel",
        "url_or_path": "C:/RoboPat/反響データ.xlsx"
      }
    ],
    "process_flow": [
      {
        "step": 1,
        "name": "SUUMO管理画面ログイン",
        "description": "環境変数からログイン情報を取得してSUUMO業務支援サイトにログイン",
        "input": "ログインID、パスワード（環境変数）",
        "output": "ログイン成功確認"
      },
      {
        "step": 2,
        "name": "反響データ画面遷移",
        "description": "反響・問い合わせ管理画面に遷移",
        "input": "ログイン後の画面",
        "output": "反響データ一覧画面"
      },
      {
        "step": 3,
        "name": "新着反響データ検索・取得",
        "description": "当日の新着反響データを検索し、データを取得",
        "input": "検索条件（当日日付）",
        "output": "新着反響データリスト"
      },
      {
        "step": 4,
        "name": "Excelファイル開始・追記",
        "description": "既存のExcelファイルを開き、取得した反響データを最終行に追記",
        "input": "反響データリスト、既存Excelファイル",
        "output": "更新されたExcelファイル"
      },
      {
        "step": 5,
        "name": "ファイル保存・ブラウザ終了",
        "description": "Excelファイルを保存し、ブラウザを終了",
        "input": "更新されたExcelファイル",
        "output": "保存完了、処理終了"
      }
    ],
    "variables": [
      {
        "name": "SUUMO_USER_ID",
        "description": "SUUMOログインID",
        "type": "STRING",
        "source": "環境変数"
      },
      {
        "name": "SUUMO_PASSWORD",
        "description": "SUUMOログインパスワード",
        "type": "STRING",
        "source": "環境変数"
      },
      {
        "name": "TARGET_DATE",
        "description": "検索対象日付（実行日）",
        "type": "STRING",
        "source": "システム日付"
      },
      {
        "name": "EXCEL_FILE_PATH",
        "description": "出力先Excelファイルパス",
        "type": "STRING",
        "source": "固定値"
      },
      {
        "name": "INQUIRY_DATA_LIST",
        "description": "取得した反響データ",
        "type": "LIST",
        "source": "Webスクレイピング結果"
      }
    ],
    "preconditions": [
      "SUUMO業務支援サイトのアカウントが有効であること",
      "環境変数にログイン情報が設定済みであること",
      "C:/RoboPatフォルダが存在すること",
      "反響データ.xlsxファイルが存在すること（初回は手動作成）",
      "インターネット接続が利用可能であること"
    ],
    "error_handling": {
      "strategy": "リトライ（最大3回）後に停止",
      "notification": "ログファイル出力、エラー発生時はメール通知"
    },
    "estimated_commands": 15
  },
  "detailed_design": {
    "project_name": "SUUMO反響データ自動取得",
    "tabs": [
      {
        "name": "初期設定・ログイン",
        "description": "環境変数取得、SUUMOサイトへのログイン処理",
        "steps": [
          {
            "id": 1,
            "command": "comment",
            "comment": "環境変数からログイン情報を取得",
            "options": {
              "text": "=== SUUMO反響データ自動取得処理開始 ==="
            }
          },
          {
            "id": 2,
            "command": "execute_script",
            "comment": "ログインIDを環境変数から取得",
            "options": {
              "script": "return process.env.SUUMO_USER_ID || '';",
              "variable": "login_id"
            },
            "error_handling": "stop"
          },
          {
            "id": 3,
            "command": "execute_script",
            "comment": "パスワードを環境変数から取得",
            "options": {
              "script": "return process.env.SUUMO_PASSWORD || '';",
              "variable": "login_password"
            },
            "error_handling": "stop"
          },
          {
            "id": 4,
            "command": "if",
            "comment": "ログイン情報が取得できているかチェック",
            "options": {
              "condition": "login_id == '' || login_password == ''"
            }
          },
          {
            "id": 5,
            "command": "script_exit",
            "comment": "ログイン情報が不足している場合は終了",
            "options": {
              "status": "1",
              "message": "環境変数からログイン情報を取得できませんでした"
            }
          },
          {
            "id": 6,
            "command": "end_if",
            "comment": "条件分岐終了",
            "options": {}
          },
          {
            "id": 7,
            "command": "open_chrome",
            "comment": "SUUMO業務支援サイトを開く",
            "options": {
              "url": "https://suumo.jp/",
              "profile": "default",
              "headless": false
            },
            "error_handling": "retry"
          },
          {
            "id": 8,
            "command": "wait_for_screen_calms",
            "comment": "画面が安定するまで待機",
            "options": {}
          }
        ]
      },
      {
        "name": "ログイン実行",
        "description": "SUUMOサイトでのログイン処理",
        "steps": [
          {
            "id": 9,
            "command": "click",
            "comment": "ログインボタンをクリック（実際のセレクタに調整要）",
            "options": {
              "selector": "a[href*='login']",
              "selector_type": "css",
              "click_type": "single",
              "wait_timeout": 10
            },
            "error_handling": "retry"
          },
          {
            "id": 10,
            "command": "input_text",
            "comment": "ログインIDを入力（実際のセレクタに調整要）",
            "options": {
              "selector": "input[name='loginId']",
              "selector_type": "css",
              "text": "${login_id}",
              "clear_first": true
            },
            "error_handling": "retry"
          },
          {
            "id": 11,
            "command": "input_password",
            "comment": "パスワードを入力（実際のセレクタに調整要）",
            "options": {
              "selector": "input[name='password']",
              "selector_type": "css",
              "password": "${login_password}"
            },
            "error_handling": "retry"
          },
          {
            "id": 12,
            "command": "click",
            "comment": "ログイン実行ボタンをクリック（実際のセレクタに調整要）",
            "options": {
              "selector": "button[type='submit']",
              "selector_type": "css",
              "click_type": "single",
              "wait_timeout": 15
            },
            "error_handling": "retry"
          },
          {
            "id": 13,
            "command": "wait_for_screen_calms",
            "comment": "ログイン完了まで待機",
            "options": {}
          }
        ]
      },
      {
        "name": "反響データ取得",
        "description": "反響データ画面への遷移と新着データの取得",
        "steps": [
          {
            "id": 14,
            "command": "execute_script",
            "comment": "本日の日付を取得",
            "options": {
              "script": "return new Date().toISOString().split('T')[0];",
              "variable": "today_date"
            }
          },
          {
            "id": 15,
            "command": "click",
            "comment": "反響・問い合わせ管理メニューをクリック（実際のセレクタに調整要）",
            "options": {
              "selector": "a[href*='inquiry']",
              "selector_type": "css",
              "click_type": "single",
              "wait_timeout": 10
            },
            "error_handling": "retry"
          },
          {
            "id": 16,
            "command": "wait_for_screen_calms",
            "comment": "反響データ画面の読み込み完了を待機",
            "options": {}
          },
          {
            "id": 17,
            "command": "input_text",
            "comment": "検索開始日に本日の日付を入力（実際のセレクタに調整要）",
            "options": {
              "selector": "input[name='fromDate']",
              "selector_type": "css",
              "text": "${today_date}",
              "clear_first": true
            },
            "error_handling": "retry"
          },
          {
            "id": 18,
            "command": "input_text",
            "comment": "検索終了日に本日の日付を入力（実際のセレクタに調整要）",
            "options": {
              "selector": "input[name='toDate']",
              "selector_type": "css",
              "text": "${today_date}",
              "clear_first": true
            },
            "error_handling": "retry"
          },
          {
            "id": 19,
            "command": "click",
            "comment": "検索ボタンをクリック（実際のセレクタに調整要）",
            "options": {
              "selector": "button[type='submit'].search-btn",
              "selector_type": "css",
              "click_type": "single",
              "wait_timeout": 10
            },
            "error_handling": "retry"
          },
          {
            "id": 20,
            "command": "wait_for_screen_calms",
            "comment": "検索結果の表示完了を待機",
            "options": {}
          }
        ]
      },
      {
        "name": "データ抽出とExcel保存",
        "description": "反響データの抽出とExcelファイルへの追記",
        "steps": [
          {
            "id": 21,
            "command": "execute_script",
            "comment": "反響データテーブルからデータを抽出（実際の構造に調整要）",
            "options": {
              "script": "var rows = document.querySelectorAll('table.inquiry-table tbody tr'); var data = []; for(var i = 0; i < rows.length; i++) { var cells = rows[i].querySelectorAll('td'); if(cells.length > 0) { data.push({ date: cells[0].textContent.trim(), name: cells[1].textContent.trim(), phone: cells[2].textContent.trim(), email: cells[3].textContent.trim(), property: cells[4].textContent.trim(), comment: cells[5].textContent.trim() }); } } return JSON.stringify(data);",
              "variable": "inquiry_data_json"
            },
            "error_handling": "continue"
          },
          {
            "id": 22,
            "command": "execute_script",
            "comment": "JSONデータを解析して件数をチェック",
            "options": {
              "script": "var data = JSON.parse('${inquiry_data_json}' || '[]'); return data.length;",
              "variable": "inquiry_count"
            }
          },
          {
            "id": 23,
            "command": "if",
            "comment": "新着データが0件の場合の処理",
            "options": {
              "condition": "inquiry_count == 0"
            }
          },
          {
            "id": 24,
            "command": "comment",
            "comment": "新着反響データなしの場合はメッセージ出力",
            "options": {
              "text": "本日の新着反響データはありませんでした"
            }
          },
          {
            "id": 25,
            "command": "script_exit",
            "comment": "正常終了",
            "options": {
              "status": "0",
              "message": "新着反響データなし - 処理正常終了"
            }
          },
          {
            "id": 26,
            "command": "end_if",
            "comment": "条件分岐終了",
            "options": {}
          },
          {
            "id": 27,
            "command": "execute_script",
            "comment": "Excelファイル操作用のスクリプト実行（実際のライブラリに調整要）",
            "options": {
              "script": "var XLSX = require('xlsx'); var fs = require('fs'); var filePath = 'C:/RoboPat/反響データ.xlsx'; var workbook; try { workbook = XLSX.readFile(filePath); } catch(e) { workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet([['日付','氏名','電話番号','メールアドレス','物件名','備考']]), '反響データ'); } var worksheet = workbook.Sheets['反響データ']; var data = JSON.parse('${inquiry_data_json}'); var range = XLSX.utils.decode_range(worksheet['!ref']); for(var i = 0; i < data.length; i++) { var newRow = range.e.r + 1 + i; XLSX.utils.sheet_add_aoa(worksheet, [[data[i].date, data[i].name, data[i].phone, data[i].email, data[i].property, data[i].comment]], {origin: 'A' + (newRow + 1)}); } XLSX.writeFile(workbook, filePath); return data.length + '件のデータを追加しました';",
              "variable": "save_result"
            },
            "error_handling": "stop"
          },
          {
            "id": 28,
            "command": "comment",
            "comment": "保存結果をログ出力",
            "options": {
              "text": "Excel保存結果: ${save_result}"
            }
          }
        ]
      },
      {
        "name": "終了処理",
        "description": "ブラウザ終了と完了通知",
        "steps": [
          {
            "id": 29,
            "command": "close_tab",
            "comment": "ブラウザタブを閉じる",
            "options": {},
            "error_handling": "continue"
          },
          {
            "id": 30,
            "command": "send_mail",
            "comment": "完了通知メール送信（オプション）",
            "options": {
              "to": "admin@company.com",
              "subject": "SUUMO反響データ取得完了",
              "body": "本日のSUUMO反響データ取得が完了しました。\\n取得件数: ${inquiry_count}件\\n保存先: C:/RoboPat/反響データ.xlsx"
            },
            "error_handling": "continue"
          },
          {
            "id": 31,
            "command": "script_exit",
            "comment": "処理正常終了",
            "options": {
              "status": "0",
              "message": "SUUMO反響データ取得処理が正常に完了しました"
            }
          }
        ]
      }
    ],
    "variables": [
      {
        "name": "login_id",
        "type": "STRING",
        "default": "",
        "description": "SUUMOログインID（環境変数から取得）"
      },
      {
        "name": "login_password",
        "type": "STRING",
        "default": "",
        "description": "SUUMOログインパスワード（環境変数から取得）"
      },
      {
        "name": "today_date",
        "type": "STRING",
        "default": "",
        "description": "実行日の日付（YYYY-MM-DD形式）"
      },
      {
        "name": "inquiry_data_json",
        "type": "STRING",
        "default": "[]",
        "description": "取得した反響データ（JSON文字列）"
      },
      {
        "name": "inquiry_count",
        "type": "STRING",
        "default": "0",
        "description": "取得した反響データの件数"
      },
      {
        "name": "save_result",
        "type": "STRING",
        "default": "",
        "description": "Excel保存処理の結果メッセージ"
      }
    ]
  }
}